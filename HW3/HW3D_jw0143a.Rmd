---
output:
  pdf_document: default
  
title: "Homework 3D - DATA-312"
author: "Jeffrey Williams"
abstract: "This writeup explores behavior in two selected MIDI files of music. A series of statistical and visual analyses is conducted to specifically make inferences and determinations of the course of temporal and tonal structure in each of the music pieces. If a song has a separate 'part', how can we determine where that part begins/ends? How can we determine when various structural changes take place in a piece of music using MIDI analysis?"
date: '`r format(Sys.time(), "%d, %B %Y")`'

---

> **SONGS CHOSEN FOR ANALYSIS**

> 1. "Gurenge" - Opening Theme from anime, _Kimetsu No Yaiba (Demon Slayer)_, originally composed by LiSA

> 2. "Unravel" - Opening Theme from anime, _Tokyo Ghoul_, originally composed by TKE\

```{r echo = FALSE, error = FALSE, message = FALSE, warning = FALSE, include = FALSE}
# Cleaning workspace and loading libraries
rm(list=ls())
gc()

library(tidyverse)
library(tuneR)
library(tabr)
library(audio)
library(GENEAread)

# "Unravel": Opening from anime, Tokyo Ghoul
# Source: https://musescore.com/kevintran99/scores/5490570
# "Gurenge": Opening from anime, Kimetsu No Yaiba (Demon Slayer)
# Source: https://sheet.host/sheet/V8Wzoq

unravel <- read_midi("unravel_tokyo_ghoul.mid")
gurenge <- read_midi("Gurenge_full.mid")

my_songs <- bind_rows(mutate(unravel, name = 'unravel'),
                   mutate(gurenge, name = 'gurenge'))

my_songs_notes <- my_songs %>% filter(!is.na(pitch)) %>%
  mutate(as_music_df(pitch), end_time = time + length)

my_songs_lengths <- my_songs_notes %>% group_by(name) %>%
  summarize(total_time = max(end_time))

my_total_notes <- my_songs %>% group_by(name) %>% 
  summarize(total_notes = sum(!is.na(pitch)))

```

> **NOTE COUNT AND SONG LENGTH**

> To set the stage for the analyses to be done in the future, we first familiarize ourselves with certain data and information about the music. For the purposes of the upcoming analyses, we particularly need to understand how long the songs are and how many notes are included in each MIDI file.

> As depicted by the following table, we see that the last note time for _Gurenge_ is `r my_songs_lengths$total_time[1]` and the last note time for _Unravel_ is `r my_songs_lengths$total_time[2]`.\

```{r}
my_songs_lengths

```

> Moreover, according to the next table, we see that the note count for _Gurenge_ is `r my_total_notes$total_notes[1]`, and for _Unravel_, the note count is `r my_total_notes$total_notes[2]`\

```{r}
my_total_notes

```

> **DIVIDING NOTES INTO TIME BLOCKS GIVEN NOTE COUNT**

> The next step in our analysis is to evenly divide notes for each song into "time blocks", portions of the MIDI file containing a set of notes each. We divide notes for each songs by several counts of time blocks. Specifically, we performed a series of analysis, having divided the music into 10, 20, 50, and 100 time blocks.

> Observe the following table, representative of both songs being divided in to 10 time blocks.

```{r include = FALSE}
knitr::opts_chunk$set(fig.height = 4.25, fig.width = FALSE, fig.align = "center")
```


```{r echo = FALSE, error = FALSE, message = FALSE, warning = FALSE}
my_songs_notes <- my_songs_notes %>% inner_join(my_songs_lengths) %>%
  inner_join(my_total_notes)

new_time_blocks <- 10

my_songs_notes_blocks <- my_songs_notes %>% inner_join(my_songs_lengths) %>%
  mutate(time_block = floor(new_time_blocks * time / total_time))

my_songs_notes_blocks %>% group_by(name) %>% count(time_block) %>%
  pivot_wider(names_from = name, values_from = n)


```

> As can be implied by the data in the table, it is possible that there are changes in the song's beat and tempo in or in between certain blocks, based on wider difference in note counts in one time block versus in the succeeding time block.

> For example, in _Gurenge_, the following differences are noticed:

> + In Time Block 2, the note count is 266. In Time Block 3, the note count jumps to 366.
> + In Time Block 5, the note count is 387, but gradually declines to 178 in Time Block 6. The note count then bounces back to 253 in Time Block 7. It then spikes to 382 in Time Block 8.\

> Likewise, in _Unravel_, the following differences are noticed:

> + In Time Block 0, the note count is 184. In Time Block 1, the note count spikes sharply to 380.
> + In Time Block 2, the note count is 326. In Time Block 3, the note count is 407.
> + In Time Block 5, the note count has risen to 501. In Time Block 6, it has diminished to 380.
> + In Time Block 8, the note count is 403. In Time Block 9, the note count has plummeted to 194.

> Throughout our analysis, as stated, we experiment with a variety of time block counts. There are differences in what we observe with one time block count and what we observe with another. To illustrate this, observe the following table, representative of the music being divided into 20 time block counts.

```{r echo = FALSE, error = FALSE, message = FALSE, warning = FALSE}
new_time_blocks <- 20

my_songs_notes_blocks2 <- my_songs_notes %>% inner_join(my_songs_lengths) %>%
  mutate(time_block = floor(new_time_blocks * time / total_time))

my_songs_notes_blocks %>% group_by(name) %>% count(time_block) %>%
  pivot_wider(names_from = name, values_from = n)

```

> As we increase the count of time blocks, consequently dividing the notes into smaller and smaller groups, we begin to see additional features that may not have been as evident with a smaller count of time blocks. Moreover, some of the results evident in one divided group might disappear in another divided group with a different time block count.

> In _Gurenge_, a few of the observations made are as follows:

> + From Time Blocks 0 to 1, the note count increases from 85 to 149.
> + From Time Blocks 1 to 2, the note count decreases from 149 to 90
> + From Time Blocks 4 to 5, the note count increases from 93 to 173.
> + From Time Blocks 8 to 9, the note count increases from 129 to 208.\

> In _Unravel_, a few of the observations made are as follows:

> + From Time Blocks 0 to 1, the note count increases from 65 to 119.
> + From Time Blocks 1 to 2, the note count increases from 119 to 200.
> + From Time Blocks 17 to 18, the note count drops from 221 to 102.\

> How

> **GRAPHICAL ANALYSIS**
> 

```{r echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
new_time_blocks <- 100

my_songs_notes_blocks <- my_songs_notes %>% inner_join(my_songs_lengths) %>%
  mutate(time_block = floor(new_time_blocks * time / total_time))

my_songs_notes_blocks %>% group_by(name) %>% count(time_block) %>%
  pivot_wider(names_from = name, values_from = n)

# Checking note usage

my_songs_notes_blocks %>% count(name, note, time_block) %>%
  ggplot(aes(time_block, n, group = note, color =  name)) + geom_line() +
  facet_wrap(~note)

my_songs_notes_blocks %>% filter(name == 'unravel') %>% 
  count(name, note, time_block) %>%
  ggplot(aes(time_block, n, group = note, color =  name)) + geom_line() +
  facet_wrap(~note)

my_songs_notes_blocks %>% filter(name == 'gurenge') %>% 
  count(name, note, time_block) %>%
  ggplot(aes(time_block, n, group = note, color =  name)) + geom_line() +
  facet_wrap(~note)


# Normalizing / Analysis of note use over time
my_songs_notes_blocks %>% filter(name == 'unravel') %>% 
  add_count(name, time_block, name = 'notes_per_block') %>% 
  add_count(note, time_block) %>%
  ggplot(aes(time_block, n / notes_per_block, group = note)) +
  geom_line() + facet_wrap(~note)

my_songs_notes_blocks %>% filter(name == 'gurenge') %>% 
  add_count(name, time_block, name = 'notes_per_block') %>% 
  add_count(note, time_block) %>%
  ggplot(aes(time_block, n / notes_per_block, group = note)) +
  geom_line() + facet_wrap(~note)

```
> **PCA ANALYSIS**

```{r}
my_songs_notes_blocks2 <- my_songs_notes %>% inner_join(my_songs_lengths) %>%
  mutate(time_block = floor(new_time_blocks * time / total_time))

note_starts1 <- my_songs_notes_blocks2 %>% group_by(name, time_block) %>%
  arrange(time,.by_group=TRUE)

note_starts2 <- note_starts1 %>% mutate(num_within_block = row_number()) %>%
  mutate(time = time - min(time))

note_starts3 <- note_starts2 %>% 
  select(name, time, time_block, num_within_block)

note_starts4 <- note_starts3 %>% 
  pivot_wider(names_from = num_within_block, values_from = time) %>% ungroup()

note_starts <- note_starts4 %>% select(name, `8`:`13`)

pca_note_starts_gurenge <- note_starts %>% filter(name == 'gurenge') %>%
  select(-name) %>% prcomp()

pca_note_starts_gurenge$x %>% as_tibble() %>% ggplot(aes(x = PC1, y = PC2)) +
  geom_count()



```